# Tools and Guardrails Gaps

Agent: tools

Upstream references
- `codex/codex-rs/core/src/tools/spec.rs`
- `codex/codex-rs/core/src/tools/handlers/apply_patch.rs`

Elixir references
- `lib/codex/tools/shell_tool.ex`
- `lib/codex/tools/apply_patch_tool.ex`
- `lib/codex/tools/web_search_tool.ex`
- `lib/codex/tools/hosted_tools.ex`
- `lib/codex/tool_guardrail.ex`
- `lib/codex/guardrail.ex`
- `lib/codex/agent_runner.ex`

Gaps and deviations
- Gap: shell tool schema mismatch. Upstream `shell` expects `command` as array with `workdir`, `timeout_ms`, `sandbox_permissions`, and `justification`; SDK `ShellTool` expects a single string `command` and `cwd`, and ignores sandbox escalation. Refs: `codex/codex-rs/core/src/tools/spec.rs`, `lib/codex/tools/shell_tool.ex`.
- Gap: shell_command tool is missing. Upstream defines `shell_command` with string `command`, `workdir`, `login`, and sandbox escalation fields. Implement a separate tool or alias with the correct schema. Refs: `codex/codex-rs/core/src/tools/spec.rs`, `lib/codex/tools/hosted_tools.ex`.
- Gap: tool aliases are missing. Upstream registers aliases (`container.exec`, `local_shell`, `shell_command`); the SDK only registers `shell`. Add aliases in tool registry. Refs: `codex/codex-rs/core/src/tools/spec.rs`, `lib/codex/tools/registry.ex`.
- Gap: write_stdin tool is missing. Upstream includes a `write_stdin` tool for unified exec sessions; SDK only exposes `command_write_stdin/4` in app-server, not as a tool. Refs: `codex/codex-rs/core/src/tools/spec.rs`, `lib/codex/app_server.ex`.
- Gap: apply_patch tool grammar mismatch. Upstream `apply_patch` uses a custom *** Begin Patch format (freeform or JSON); SDK parser expects unified diff headers (---/+++). Implement the upstream grammar and semantics (add/delete/update/move). Refs: `codex/codex-rs/core/src/tools/handlers/apply_patch.rs`, `lib/codex/tools/apply_patch_tool.ex`.
- Gap: view_image tool is missing from hosted tools. Upstream exposes `view_image` for local image attachments; SDK has ImageView items but no tool to produce them. Refs: `codex/codex-rs/core/src/tools/spec.rs`, `lib/codex/items.ex`.
- Gap: web_search tool schema mismatch. Upstream web_search is gated by `features.web_search_request` and uses the canonical web search tool schema; SDK WebSearchTool uses external providers with different arguments. Implement a canonical `web_search` tool or map to existing provider adapters. Refs: `codex/codex-rs/core/src/tools/spec.rs`, `lib/codex/tools/web_search_tool.ex`.
- Gap: guardrail run_in_parallel and behavior are unused. Guardrails run sequentially and ignore behavior semantics; tripwire handling is identical to reject. Implement parallel execution and behavior handling (allow, reject, raise). Refs: `lib/codex/tool_guardrail.ex`, `lib/codex/guardrail.ex`, `lib/codex/agent_runner.ex`.
- Deviation: SDK defines extra hosted tools (computer, vector_store_search, image_generation, code_interpreter) that are not present in codex CLI. Decide whether to keep them behind feature flags or document as SDK-only. Refs: `lib/codex/tools/hosted_tools.ex`.
- Deviation: shell execution uses `sh -c` and escaped strings; upstream uses execvp with argv arrays. This can change quoting and PATH resolution. Refs: `lib/codex/tools/shell_tool.ex`, `codex/codex-rs/core/src/tools/spec.rs`.

Implementation notes
- Align tool metadata with upstream schemas so tool calls generated by the model can be reused across transports.
- Consider adding a compatibility layer that accepts both the upstream schema and the existing SDK schema for a transition period.
